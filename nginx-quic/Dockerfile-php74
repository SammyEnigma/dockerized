FROM    eilandert/php-fpm:7.4
LABEL   maintainer="Thijs Eilander <eilander@myguard.nl>"
ENV     DEBIAN_FRONTEND="noninteractive"

COPY    bootstrap.sh /bootstrap.sh

RUN set -ex ;\
    echo "deb [trusted=yes] http://deb.myguard.nl/quic/ ${DIST} main" > /etc/apt/sources.list.d/quic.list ;\
    echo "deb [trusted=yes] http://edge.deb.myguard.nl:8888/apt/nginx-quic/ ${DIST} main" >> /etc/apt/sources.list.d/quic.list ;\
    apt-get update ;\
    apt-get -y upgrade ;\
    apt-get -y --no-install-recommends install \
      brotli \
      curl \
      fcgiwrap \
      geoip-bin \
      libjemalloc2 \
      lua-resty \
      mimalloc \
      modsecurity-crs \
      nginx-full \
      ssl-cert \
      zstd \
      libnginx-mod-ssl-ct \
      libnginx-mod-http-ssl-ct \
      libnginx-mod-stream-ssl-ct \
    ;\
    apt-get -y autoremove && apt-get -y autoclean && rm -rf /var/lib/apt/lists/* ;\
    mv /etc/nginx /etc/nginx.orig && mkdir -p /etc/nginx ;\
    mv /etc/modsecurity /etc/modsecurity.orig && mkdir -p /etc/modsecurity ;\
    chmod +x /bootstrap.sh ;\
    rm -f /var/spool/nullmailer/trigger ;\
    echo "background_thread:true,metadata_thp:auto" > /etc/malloc.conf

CMD     ["/bootstrap.sh"]
EXPOSE  80 80
EXPOSE  443 443

WORKDIR /etc/nginx
